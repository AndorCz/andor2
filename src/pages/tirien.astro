---
import LayoutTirien from '@layouts/layoutTirien.astro'

export const prerender = false

const { user } = Astro.locals

// Avoid caching so the iframe always reflects current auth cookies
Astro.response.headers.set('Cache-Control', 'no-store')

// Get supabase user auth
const accessToken = Astro.cookies.get('sb-access-token')?.value
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value

// Path based on environment
const path = import.meta.env.DEV ? 'http://localhost:5173' : 'https://tirien.cz'
const params = new URLSearchParams()
if (accessToken && refreshToken) {
  params.set('accessToken', accessToken)
  params.set('refreshToken', refreshToken)
}
params.set('embed', 'true')
const iframeSrc = `${path}?${params}`
---

<LayoutTirien title='Tirien: Hlavní město Andoru' sidePadding={false}>
  <script type='module'>
    import { supabase } from '@lib/database-browser'

    const allowedOrigins = new Set([
      import.meta.env.DEV ? 'http://localhost:5173' : 'https://tirien.cz'
    ])

    // Listen for auth sync messages from Tirien iframe
    window.addEventListener('message', async (event) => {
      if (!allowedOrigins.has(event.origin)) return
      const { type, session } = event.data ?? {}
      if (type !== 'tirien-auth-sync' || !session?.access_token || !session?.refresh_token) return
      try {
        await supabase.auth.setSession(session)
        await fetch('/api/auth/sync', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ access_token: session.access_token, refresh_token: session.refresh_token })
        })
      } catch (syncError) {
        console.error('Failed to sync session from Tirien iframe:', syncError)
      }
    })
  </script>
  {user.id ? (
    <div class='tirien-iframe-container'>
      <iframe 
        src={iframeSrc}
        width='100%' 
        height='100%'
        frameborder='0'
        allow='autoplay; encrypted-media; fullscreen'>
      </iframe>
    </div>
  ) : (
    <center>Tato sekce je jen pro přihlášené uživatele.</center>
  )}
</LayoutTirien>

<style>
  .tirien-iframe-container {
    width: 100%;
    height: 100%;
    overlay: hidden;
  }
</style>
