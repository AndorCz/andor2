---
  import { handleError } from '@lib/database'
	import Layout from '@layouts/layout.astro'
  import Board from '@components/boards/Board.svelte'
  import BoardSettings from '@components/boards/BoardSettings.svelte'

  const { supabase, user, bookmarks } = Astro.locals
  const { boardId } = Astro.params

  const showSettings = Astro.url.searchParams.get('settings')

  const { data: boardData, error } = await supabase.from('boards').select('id, name, thread, header, owner:profiles(id, name), custom_header').eq('id', boardId).single()
  if (error) { handleError(error) }

  const { data: unreadData, error: error2 } = await supabase.rpc('get_thread_unread', { thread: boardData.thread })
  if (error2) { handleError(error2) }
  if (unreadData) { boardData.unread = unreadData }
---

<script>
  import { lookForToast } from '@lib/toasts'
  lookForToast()
</script>

<Layout title={boardData?.name} headerStorageId={boardData?.custom_header ? 'board-' + boardData.id : null}>
  {(showSettings ? (
    <BoardSettings data={boardData} {user} client:only />
  ) : (
    <Board data={boardData} {user} client:only />
  ))}
</Layout>
