---
	import Layout from '@layouts/layout.astro'
  import GameList from '@components/games/GameList.svelte'

  const { supabase, user } = Astro.locals
  
  const tab = Astro.url.searchParams.get('tab') || 'open'
  const sort = Astro.url.searchParams.get('sort') || 'new'

  let query = supabase.from('game_list').select('*')
  switch (tab) {
    case 'open':
      query.match({ archived: false, published: true, recruitment_open: true })
      break
    case 'public':
      query.match({ archived: false, published: true, open_game: true })
      break
    case 'private':
      query.match({ archived: false, published: true, open_game: false })
      break
    case 'archive':
      query.match({ archived: true, published: true })
      break
    case 'all':
      query.match({ published: true })
      break
  }

  switch (sort) {
    case 'new':
      query.order('created_at', { ascending: false })
      break
    case 'active':
      query.not('last_post', 'is', null).order('last_post', { ascending: false })
      break
  }

  const { data: games, error } = await query
  if (error) { console.error(error) }
---

<Layout title='Hry'>
  <GameList {user} {games} showHeadline client:load />
</Layout>
