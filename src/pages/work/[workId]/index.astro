---
	import Layout from '@layouts/layout.astro'
  import Work from '@components/works/Work.svelte'
  import WorkSettings from '@components/works/WorkSettings.svelte'

  const { supabase, user, bookmarks } = Astro.locals
  const { workId } = Astro.params

  const showSettings = Astro.url.searchParams.get('settings')

  const { data: workData, error } = await supabase.from('works').select('id, type, name, content, thread, author:profiles(id, name), tags, category, custom_header, likes, dislikes, created_at').eq('id', workId).single()
  if (error) { return Astro.redirect(`/?toastType=error&toastText=${encodeURIComponent('Chyba: ' + error.message)}`) }

  const { data: unreadData, error: error2 } = await supabase.rpc('get_thread_unread', { thread: workData.thread })
  if (error2) { return Astro.redirect(`/?toastType=error&toastText=${encodeURIComponent('Chyba: ' + error2.message)}`) }
  if (unreadData) { workData.unread = unreadData }
---

<script>
  import { lookForToast } from '@lib/toasts'
  lookForToast()
</script>

<Layout title={workData?.name} headerStorageId={workData?.custom_header ? 'work-' + workData.id : null}>
  {(showSettings ? (
    <WorkSettings data={workData} {user} client:only />
  ) : (
    <Work data={workData} {user} client:only />
  ))}
</Layout>
